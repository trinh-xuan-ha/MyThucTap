;/*FB_PKG_DELIM*/

__d("MAWCreateOptimisticAttachmentFromEB",["EchoMessageMediaFieldUtils","I64","LSAuthorityLevel","LSIntEnum","MessagingAttachmentType","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a){switch(a){case d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return c("MessagingAttachmentType").IMAGE;case d("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return c("MessagingAttachmentType").STICKER;case d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return c("MessagingAttachmentType").VIDEO;case d("EchoMessageMediaFieldUtils").AttachmentType.GIF:return c("MessagingAttachmentType").ANIMATED_IMAGE;case d("EchoMessageMediaFieldUtils").AttachmentType.PTT:return c("MessagingAttachmentType").AUDIO;case d("EchoMessageMediaFieldUtils").AttachmentType.XMA:return c("MessagingAttachmentType").XMA;case d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return c("MessagingAttachmentType").FILE}}function a(a,b,c,d,e,f){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,k){a=(h||(h=d("I64"))).of_float(k);k={attachmentFbid:h.to_string(h.max_int),attachmentIndex:h.zero,attachmentType:(i||(i=d("LSIntEnum"))).ofNumber(j(f.attachmentType)),authorityLevel:i.ofNumber(c("LSAuthorityLevel").OPTIMISTIC),hasMedia:f.attachmentType!==d("EchoMessageMediaFieldUtils").AttachmentType.XMA,hasXma:f.attachmentType===d("EchoMessageMediaFieldUtils").AttachmentType.XMA,isSharable:!1,messageId:g,threadKey:e,timestampMs:a};f.size!=null&&(k=babelHelpers["extends"]({},k,{filesize:(h||(h=d("I64"))).of_float(f.size)}));f.previewContentHeight!=null&&(k=babelHelpers["extends"]({},k,{previewHeight:(h||(h=d("I64"))).of_float(f.previewContentHeight)}));f.previewContentWidth!=null&&(k=babelHelpers["extends"]({},k,{previewWidth:(h||(h=d("I64"))).of_float(f.previewContentWidth)}));yield b.attachments.add(k)});return k.apply(this,arguments)}g["default"]=a}),98);
__d("MAWCreateOptimisticMessageFromEB",["EchoMessage","I64","LSAuthorityLevel","LSHotEmojiSize","LSIntEnum","LSMessageSendStatus","MAWAdminMsg","MAWBridgeBuildMsg","MAWLocalizationType","asyncToGeneratorRuntime","cr:2472"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a,b){if(a==null)return 1;if(b!=null&&b===!0)return 8192;switch(a){case d("EchoMessage").EchoXMessageContentType.TEXT:return 1;case d("EchoMessage").EchoXMessageContentType.IMAGE:case d("EchoMessage").EchoXMessageContentType.VIDEO:return 2;case d("EchoMessage").EchoXMessageContentType.AUDIO:return 4;case d("EchoMessage").EchoXMessageContentType.STICKER:return 4096;case d("EchoMessage").EchoXMessageContentType.GIF:return 16384;case d("EchoMessage").EchoXMessageContentType.XMA:return 1024;case d("EchoMessage").EchoXMessageContentType.DOCUMENT:return 64;default:return 1}}function a(a,b,c,d,e,f,g,h,i,j,l){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,k,l,m,n,o,p,q){var r=(h||(h=d("I64"))).of_float(q);o=o;p(o);p=(yield d("MAWBridgeBuildMsg").buildOptimisticMessage(e,void 0,n));yield a.messages.add(babelHelpers["extends"]({},p,{authorityLevel:(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),displayedContentTypes:i.ofNumber(j(f,g)),hasQuickReplies:!1,hotEmojiSize:m,isAdminMessage:!1,isCollapsed:!1,isUnsent:!1,messageId:o,offlineThreadingId:o,primarySortKey:r,senderId:l,sendStatus:i.ofNumber(c("LSMessageSendStatus").SERVER_RECEIVED),sendStatusV2:i.ofNumber(2),textHasLinks:!1,threadKey:k,timestampMs:r,transportKey:"EncryptedBackups",viewFlags:i.ofNumber(0)}));n=b("cr:2472")==null?e:b("cr:2472").unvault(e);a=m!=null&&(h||(h=d("I64"))).equal(m,(i||(i=d("LSIntEnum"))).ofNumber(c("LSHotEmojiSize").SMALL))&&n==="\ud83d\udc4d"?"(Y)":e;p=d("MAWAdminMsg").buildLocalizedString([a],[],d("MAWLocalizationType").CURRENT_USER_SEND_TEXT);return{offlineMsgId:o,senderId:l,serverTsInMilliseconds:q,snippetString:p}});return k.apply(this,arguments)}g["default"]=a}),98);
__d("MAWRestoreMessagesFromEncryptedBackupsNOP",["I64","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MAWBridgeTraceRecordCheckpointHandler","MAWBridgeUpdateClientRestoreStatus","MAWChatJid","MAWEBRestoreTrackingUtils","MAWEncryptedBackupsUpdateGlobalRestoreStatus","MAWJobDefinitions","MAWMIC","MAWOfflineQueueStatus","MAWTimedJob","MAWUpdateClientRestoreStatusOperationType","Promise","ReQL","WAJobOrchestratorTypes","WALoggerDeferred","WATagsLogger","asyncToGeneratorRuntime","cr:4992","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Calling worker job for thread "," StartSortKey: "," messagesCount: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Calling prefetch for thread ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get thread key for "," when calling restoreMessagesFromEncryptedBackup"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][","] Received echo documents for thread: "," startSortKey: "," messagesCount: ",""]);n=function(){return a};return a}function o(a,b){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){try{c=(yield d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(j||(j=d("I64"))).of_string(c)));if(c!=null){a=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.messages_ranges_v2__generated).getKeyRange(c)));if(a!=null)return a.minMessageId}}catch(a){return(h||(h=b("Promise"))).reject(a)}return});return p.apply(this,arguments)}function q(a,b,c){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){if(b===0){yield d("MAWMIC").startMAWMICFlow();d("MAWMIC").markEvent("eb_restore_start");c&&d("MAWMIC").markEvent("eb_prefetch_start");return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table)).then(function(a){a.forEach(function(a){a=d("MAWJobDefinitions").toThreadJidPrimaryId((j||(j=d("I64"))).to_string(a.jid));d("MAWEncryptedBackupsUpdateGlobalRestoreStatus").addThreadIdToStatusArray(a,"restore");c&&d("MAWEncryptedBackupsUpdateGlobalRestoreStatus").addThreadIdToStatusArray(a,"ebprefetch")})})}});return r.apply(this,arguments)}function a(a,b,c,d,e,f,g,h,i,j,k,l,m){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,p,r,s,u,v,w,x,y,z){var A;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(A=w)!=null?A:""]).LOG(n(),(A=w)!=null?A:"",f,x,g.length);A=(yield d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(j||(j=d("I64"))).of_string(f)));A==null&&void d("WALoggerDeferred").ERROR(m(),f);A=!d("MAWOfflineQueueStatus").isOfflineQueueComplete()&&b("cr:4992")!=null&&x==null&&f!=null;var B=d("MAWEncryptedBackupsUpdateGlobalRestoreStatus").getCurrentGlobalRestoreStatusArrayLength("restore");yield q(a,B,A);try{B=(yield o(a,f));if(A&&b("cr:4992")!=null){d("WATagsLogger").TAGS(["labyrinth_web","eb_prefetch",(A=w)!=null?A:""]).LOG(l(),f);d("MAWEBRestoreTrackingUtils").markEBRestoreFrontloaded(y,w);A={action:d("MAWUpdateClientRestoreStatusOperationType").upsertClientRestoreStatus,threadId:f};yield d("MAWBridgeUpdateClientRestoreStatus").call(a,A);yield b("cr:4992")(a,e,f,g,p,r,s,u,v,w,x,B,y,z)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(A=w)!=null?A:""]).LOG(k(),f,x,g.length);c("promiseDone")(t(e,f,g,B,p,s,v,w,x,y,z))}}catch(e){if(w!=null)return d("MAWBridgeTraceRecordCheckpointHandler").call(a,{checkPointId:(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").FLOW_END_FOR_FAILURE),dataTraceId:w,errorMessage:e,shouldFlush:!0,syncChannel:-1,tags:void 0}).then(function(){return(h||(h=b("Promise"))).reject(e)})}});return s.apply(this,arguments)}function t(a,b,e,f,g,h,i,j,k,l,m){if(j!=null&&l===c("LSMEBTaskCreationSource").MESSENGER_MESSAGE_LIST_PAGINATION&&c("gkx")("3278")){var n;return d("MAWTimedJob").TimedUIJobStarters.waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.restoreMessagesFromEncryptedBackups(a,b,e,g,h,i,(n=f)!=null?n:void 0,(n=j)!=null?n:void 0,(n=k)!=null?n:void 0,void 0,void 0,l,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},m)).then(function(a){if(!c("gkx")("23935"))if(a.success===!0)d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryUponReStore(j);else{var b;d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(j,(b=a.payload)!=null?b:c("err")(a.error))}})}return d("MAWTimedJob").TimedUIJobStarters.fireAndForget(d("MAWJobDefinitions").jobSerializers.restoreMessagesFromEncryptedBackups(a,b,e,g,h,i,(n=f)!=null?n:void 0,(a=j)!=null?a:void 0,(b=k)!=null?b:void 0,void 0,void 0,l,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},m))}g.call=a}),98);
__d("MAWRestoreMessagesFromEncryptedBackupsPrefetch",["EchoMessage","I64","LSDatabaseSingleton","MAWBridgeReactionUpsertHandler","MAWBridgeUpdateClientRestoreStatus","MAWBumpThread","MAWChatJid","MAWCreateOptimisticAttachmentFromEB","MAWCreateOptimisticMessageFromEB","MAWJobDefinitions","MAWThreadId","MAWTimedJob","MAWUpdateClientRestoreStatusOperationType","MAWVault","Promise","QPLUserFlow","Random","ReQL","WAJobOrchestratorTypes","WALoggerDeferred","WAStanzaUtils","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get thread key for ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Authoritative timestamp not set for echo message. Message origin: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid timestamp for echo message corresponding to 1/1/1970. Message origin: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] decoded echo objects: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to create optimistic message as offline threading id doesn't exist in echo message"]);o=function(){return a};return a}function p(a,b){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.messages).getKeyRange(b)));return a!=null?a.timestampMs:void 0});return q.apply(this,arguments)}function r(a,b,c,d){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f){c.reactions!=null&&(yield (j||(j=b("Promise"))).all(c.reactions.map(function(g,h){if(c.reactionAuthoritativeTimestampMs!=null&&h<c.reactionAuthoritativeTimestampMs.length){var i=g.displayName;h=c.reactionAuthoritativeTimestampMs[h];if(i!=null&&h!=null){h=d("WATimeUtils").castToUnixTime(Number(h)/1e3);g=g.localKey;return d("MAWBridgeReactionUpsertHandler").attachmentMutationsOptimisticHandler(a,g,e,f,h,i)}}return(j||(j=b("Promise"))).resolve()})))});return s.apply(this,arguments)}function t(a,e,f,g,i){if(f!=null){var k=f.threadKey,l=[];return a.reduce(function(a,g){return a.then(function(){if(g!=null&&f!=null){var a=g.from;if((a==null?void 0:a.localKey)!=null){var m=g||{},n=m.isForwarded,o=m.text;o=o===void 0?"":o;var p=m.xContentType,q=m.xOfflineThreadingId;m=v(g);if(m==null)return(j||(j=b("Promise"))).resolve();o=q!=null?c("MAWCreateOptimisticMessageFromEB")(i,d("MAWVault").vault(o),p,n,f.threadKey,(h||(h=d("I64"))).of_string(a.localKey),void 0,[],q,function(){},m):(j||(j=b("Promise"))).resolve(null);return o.then(function(a){if(a!=null){l.push(a);a={msgId:a.offlineMsgId,ts:a.serverTsInMilliseconds};q!=null&&e.set(d("WAStanzaUtils").toStanzaId(q),a);if(g.reactions!=null)return r(i,g,k,a.msgId).then(function(){})}else d("WATagsLogger").TAGS(["labyrinth_web","eb_frontloading"]).ERROR(["[labyrinth_web] Unable to create optimistic message as offline threading id doesn't exist in echo message"])})}else return(j||(j=b("Promise"))).resolve()}else return(j||(j=b("Promise"))).resolve()})},(j||(j=b("Promise"))).resolve()).then(function(){return d("MAWBridgeUpdateClientRestoreStatus").call(i,{action:d("MAWUpdateClientRestoreStatusOperationType").markCompleteClientRestoreStatus,ebPrefetch:!0,threadId:g})}).then(function(){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(i.threads).getKeyRange(k)).then(function(a){if(a!=null)return(j||(j=b("Promise"))).all(l.map(function(a){var c=(h||(h=d("I64"))).of_float(a.serverTsInMilliseconds);if((h||(h=d("I64"))).equal(f.lastActivityTimestampMs,c))return d("MAWBumpThread").threadMutation(i,k,c,c,a.snippetString,a.senderId);else return(j||(j=b("Promise"))).resolve()})).then(function(){return(j||(j=b("Promise"))).resolve()})})})}return(j||(j=b("Promise"))).resolve()}function u(a,e,f,g,h){if(f==null)return(j||(j=b("Promise"))).resolve();var i=f.threadKey;g=a.filter(function(a){return(a==null?void 0:a.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA||(a==null?void 0:a.contentType)===d("EchoMessage").EchoMessageContentType.XMA});return(j||(j=b("Promise"))).all(g.map(function(a){var g;if(f==null||(a==null?void 0:(g=a.from)==null?void 0:g.localKey)==null)return(j||(j=b("Promise"))).resolve();g=a||{};a=g.authoritativeTimestampMs;var k=g.displayTimestampMs,l=g.mediaData;g=g.xOfflineThreadingId;if(l==null)return(j||(j=b("Promise"))).resolve();a=a!=null?d("WATimeUtils").castToUnixTime(a):d("WATimeUtils").castToUnixTime(k||0);return g!=null?c("MAWCreateOptimisticAttachmentFromEB")(e,h,i,l,g,a):(j||(j=b("Promise"))).resolve(function(){void d("WALoggerDeferred").ERROR(o())})})).then(function(){return(j||(j=b("Promise"))).resolve()})}function v(a){var b=15778656e5,c=a==null?void 0:a.authoritativeTimestampMs;if(c!=null&&c>b)return c;else if((a==null?void 0:a.displayTimestampMs)!=null)return a.displayTimestampMs;return null}function w(a){if((a==null?void 0:a.contentType)==null)return!1;switch(a.contentType){case d("EchoMessage").EchoMessageContentType.TEXT:case d("EchoMessage").EchoMessageContentType.MEDIA:case d("EchoMessage").EchoMessageContentType.XMA:return!0;default:return!1}}function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,j,o,q,r,s,v,x,y,z){j=new Map();q=(yield d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(h||(h=d("I64"))).of_string(e)));var A=Math.floor(d("Random").random()*1e4)+Date.now()+1e4;c("QPLUserFlow").start(c("qpl")._(521482576,"1069"),{annotations:{bool:{isInitialRestore:v==null,isPointRestore:r},string:{thread_id:e}},instanceKey:A});c("QPLUserFlow").addPoint(c("qpl")._(521482576,"1069"),"optimistic_message_restore_start",{instanceKey:A});if(q!=null){var B=(yield d("MAWThreadId").getThreadFromJid(a,q)),C=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton),D=f.map(function(a){return d("EchoMessage").decodeEchoMessage(a)});void d("WALoggerDeferred").LOG(n(),D.length);var E=(yield p(a,q));q=D.filter(function(a){return B!=null&&a!=null&&(E==null||a.sortOrderMs>(h||(h=d("I64"))).to_float(E))}).filter(w).filter(function(a){if((a==null?void 0:a.authoritativeTimestampMs)!=null&&(a==null?void 0:a.authoritativeTimestampMs)===0||(a==null?void 0:a.authoritativeTimestampMs)==null&&(a==null?void 0:a.displayTimestampMs)!=null&&(a==null?void 0:a.displayTimestampMs)===0){void d("WALoggerDeferred").ERROR(m(),a.serializationOrigin);return!1}(a==null?void 0:a.authoritativeTimestampMs)===null&&void d("WALoggerDeferred").ERROR(l(),a.serializationOrigin);return!0});yield t(q,j,B,e,a);yield u(q,C,B,e,a);c("QPLUserFlow").addPoint(c("qpl")._(521482576,"1069"),"optimistic_message_restore_end",{data:{"int":{messages_optimistically_restored:j.size}},instanceKey:A});c("promiseDone")(d("MAWTimedJob").TimedUIJobStarters.fireAndForget(d("MAWJobDefinitions").jobSerializers.restoreMessagesFromEncryptedBackups(b,e,f,g,o,r,(D=x)!=null?D:void 0,(q=s)!=null?q:void 0,(C=v)!=null?C:void 0,A,j,y,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},z)))}else void d("WALoggerDeferred").ERROR(k(),e)});return x.apply(this,arguments)}g["default"]=a}),98);